<!DOCTYPE html>
<html>
<head>
  <title>IO LAB</title>
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <!-- <link href="../assets/css/bootstrap.css" rel="stylesheet"> -->
  <style type="text/css">
    body {
      padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
    }
    .picture{
      margin: 5px; display: inline-block;
    }

    /* Set the fixed height of the footer here */
    #push,#footer {
      height: 60px;
      padding-top: 10px;
     }
    #footer{ 
      background-color: #f5f5f5;
    }
    /* Lastly, apply responsive CSS fixes as necessary */
    @media (max-width: 767px) {
      #footer {
        margin-left: -20px;
        margin-right: -20px;
        padding-left: 20px;
        padding-right: 20px;
      }
    }

  </style>

<script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      // Google Chart Visualization: Line Chart 
      // https://google-developers.appspot.com/chart/interactive/docs/gallery/linechart
      // ==============================================================================
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Day', 'rain', 'flood','trees','flooding','power'],
          ['Oct 28',  2537, 2030, 3278,2007,2084],
          ['Oct 29',  7696, 7457, 7933,7461,7354],
          ['Oct 30',  11040,10745,11473,10403,10490],
          ['Oct 31',  3960, 3648, 4591,3653,3725],
          ['Nov 1',   2245, 2069, 2913,2082, 2349]
        ]);

        var options = {
          title: '#Sandy on Flickr'
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(data, options);
        chrt=chart;
        dta=data;
        console.log(dta);
        console.log(chart);
        console.log(chart.getSelection());

        // Every time the chart fires the "select" event, it should call the
        // selectHandler() function.
        google.visualization.events.addListener(chart, 'select', selectHandler);

        function selectHandler(e) {
          var selectedItem = chart.getSelection()[0];
          if (selectedItem) {
            var value = data.getValue(selectedItem.row, selectedItem.column);
            var date=data.getValue(selectedItem.row,0)
            var dataPointTags=data.getColumnLabel(selectedItem.column);
  
            alert('The user selected ' + value+ " ((ROW:"+selectedItem.row+" COL:"+selectedItem.column+" )) TAG: "+ dataPointTags+ "  DATE:"+date);
            console.log('>>STATUS: data point clicked: '+value+'   '+dataPointTags)
            
            getDataPointImages(dataPointTags); //call function 
            
          }
        }
      }

    //making the datapoints clickable (show related pictures from flickr)
    // $(document).ready(function(){
    //global variables 
    var apiKey='8ec893d32fd65f1adef810ce04f744b5';
    // var dataPointTags='sandy%2C+rain'
    var pictureIDs=[];//IDs of pictures related to the clicked data point
    var stringIDs='';
    console.log('>>STATUS: vars instantiated, document ready..');

    //function that calls the Flickr search API and returns photo IDs related to the tags that are clicked on the graph
    //NOTE: need to get this to detect clicked date value as well
    function getDataPointImages(dataPointTags){
      var formatTags='sandy%2C+'+dataPointTags;
      console.log('>>STATUS: getting dp ..argument tags= '+formatTags);
      //REFERENCE for using nojsoncallback=1 in the API call is http://stackoverflow.com/questions/1741510/jquery-getjson-never-enters-its-callback-function
      $.getJSON('http://api.flickr.com/services/rest/?method=flickr.photos.search&api_key='+apiKey+'&tags='+dataPointTags+'&tag_mode=AND&min_taken_date=20121028&format=json&nojsoncallback=1', 
        function(json){
          console.log('>>STATUS: in getDataPointImages(): Calling searct API, json object returned for arguments:'+dataPointTags);
          var photoObjs=json.photos.photo;//drill down to photo objects
          console.log(json);
          // console.log(photoObjs);
          //add IDs to a global array
          for (var i in photoObjs){pictureIDs.push(photoObjs[i].id);} 
          //add IDs to a global string 
          for (var i in photoObjs){stringIDs+=(photoObjs[i].id+',');} 
          console.log('>>STATUS: IDs added to string: '+stringIDs);

          //clear the pictures div element 
          $('#pix').children().remove();
          //download the new images from flickr (relevent to clicked data point)
          downloadImg(stringIDs,dataPointTags);
        } 
      );
    }
    //use the public feed to show images with the specified tags (using their links)
    //problem: no option to set date
    //other possible solution: use the photo info API
    function downloadImg(photoIDs,tagsArg) {
      var allTags=tagsArg+', sandy';
    $.getJSON("http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",
        {ids : '', tags: allTags,tagmode: "and",format: "json", }, 
        function(obj){
          console.log('>>STATUS: in downloadImg(): printing data from download image call for tags: '+allTags);
          console.log(obj);
          //append flickr images to the #pix div element 
          $.each(obj.items, function(i,item){
            $("<img/>").attr({ src: (item.media.m).replace("_m.jpg", "_s.jpg"),href: item.link,alt: item.title+', '+item.date_taken,}).appendTo("#pix").wrap("<div class='picture'><a rel='external' href=\""+item.link+"\"></a></div>");

            if ( i == 10 ) return false;
            });
          });
        }
  // });

    </script>


</head>
<body>

   <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
      <a class="brand" href="#">IO Lab Project 3</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h3>Tagging Sandy</h3>
    <p>Visualizing tags from Flickr. Click a data point to see related images.</p>
    <!-- Google chart: line chart -->
    <div id="chart_div" style="width: 800px; height: 400px;"></div>
  </div> <!-- /container -->

  <!-- pictures -->
  <div id="pix" class="container"></div>
  
  <!-- <div id="footer">
    <div class="container">
      <p class="muted credit">By x and y.</p>
    </div>
  </div> -->

</body>
</html>